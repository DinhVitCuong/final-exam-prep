<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body,
      html {
        width: 100%;
        height: 100%;
        display: flex;
      }
      .test-page {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        justify-content: space-between;
        align-items: start;
        background-color: white;
        flex-wrap: wrap;
        width: 100%;
        height: 100%;
        padding-left: 16px;
        padding-right: 16px;
        padding-top: 16px;
      }
      button {
        background-color: transparent;
        border: none;
        cursor: pointer;
      }
      button:hover {
        opacity: 0.6;
      }
      .button--back {
        position: absolute;
        top: 0;
        left: 0;
        padding: 10px;
      }
      .header {
        flex-basis: 60%;
        display: flex;
        justify-content: center;
      }
      .header__content,
      .countdown__content {
        padding: 0.7rem 1rem;
        font-size: 1.5rem;
        background-color: #1976d2;
        width: 50%;
        text-align: center;
        border-radius: 24px;
      }
      .countdown {
        flex-basis: 39%;
        display: flex;
        justify-content: center;
      }
      .current-question__container {
        flex-basis: 65%;
        border: gray 1px solid;
        height: 80%;
        border-radius: 20px;
        padding: 16px;
        box-shadow: inset 0 0 2px 1px #000000;
      }
      .questions-list__container {
        flex-basis: 30%;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
        border: gray 1px solid;
        height: 70%;
        border-radius: 20px;
        padding: 16px;
        box-shadow: inset 0 0 2px 1px #000000;
      }
      .button--submit {
        position: absolute;
        bottom: 0;
        right: 0;
        margin-bottom: 48px;
        margin-right: 48px;
        background-color: #4caf50;
        font-size: 1.6em;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 24px;
      }
      .question-item { width: 50px; height: 50px; border: 2px solid black; display: flex; align-items: center; justify-content: center; margin: 10px; cursor: pointer; }
      .selected-question { border: 4px solid black; }
    </style>
  </head>
  <body>
    <div class="test-page">
      <button class="button--back">
        <img src="/assets/left-arrow-slider.svg" />
      </button>

      <div class="header">
        <div class="header__content">
          <p>Bài kiểm tra tổng</p>
        </div>
      </div>
      <div class="countdown">
        <div id="timer", class="countdown__content">45:00</div> <!-- Timer display -->
      </div>
      <div class="current-question__container">
        <img src="" alt="question-icon" />
        <p class="current-question__content">Câu 1: 1 + 1 bằng mấy?</p>
        <div class="current-question__options-container">
          <div class="current-question__option option--A">
            <input type="radio" name="option" id="option-A" />
            <label for="option-A">A</label>
            <p class="option__content option__content--A">2</p>
          </div>
          <div class="current-question__option option--B">
            <input type="radio" name="option" id="option-B" />
            <label for="option-B">B</label>
            <p class="option__content option__content--B">2</p>
          </div>
          <div class="current-question__option option--C">
            <input type="radio" name="option" id="option-C" />
            <label for="option-C">C</label>
            <p class="option__content option__content--C">2</p>
          </div>
          <div class="current-question__option option--D">
            <input type="radio" name="option" id="option-D" />
            <label for="option-D">D</label>
            <p class="option__content option__content--D">2</p>
          </div>
        </div>
      </div>
      <form id="testForm" action="/submit" method="POST">
        <button class="button button--submit" onclick="submitForm()">SUBMIT</button>
      </form>
      <div id="question-list", class="questions-list__container">
        {% for i in range(1, total_questions + 1) %}
            <div class="question-item {% if i == question_number %}selected-question{% endif %}" 
                onclick="selectQuestion({{ i }})">
                {{ i }}
            </div>
        {% endfor %}
      </div>
    </div>
  </body>
  <script>
    let currentQuestion = 1;
    let questions = {{ questions|tojson }};
    let selections = JSON.parse(localStorage.getItem('selections')) || {};
    let startTime = Date.now();
    let timeLimit = {{ time_limit }} * 60;  // Time limit in seconds

    function startTimer() {
        const timerElement = document.getElementById('timer');
        const interval = setInterval(() => {
            const minutes = Math.floor(timeLimit / 60);
            const seconds = timeLimit % 60;
            timerElement.textContent = `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
            timeLimit--;

            if (timeLimit < 0) {
                clearInterval(interval);
                alert('Time is up! Submitting your answers.');
                document.getElementById('testForm').submit();  // Auto-submit the form
            }
        }, 1000);
    }

    function selectQuestion(questionNumber) {
        // Calculate and save time spent on the current question
        let timeSpent = (Date.now() - startTime) / 1000; // in seconds
        console.log("Time spent on question " + currentQuestion + ": " + timeSpent + " seconds");

        if (currentQuestion > 0) {
            const currentQuestionId = questions[currentQuestion - 1]["ID"];
            if (!selections[currentQuestionId]) {
                selections[currentQuestionId] = {};
            }
            selections[currentQuestionId].timeSpent = timeSpent; // Save the time spent
        }

        // Reset timer for the new question
        startTime = Date.now();

        // Update the question text and options
        const questionData = questions[questionNumber - 1];
        document.getElementById('question-text').innerText = questionData["question"];
        
        let optionsHtml = "";
        questionData["options"].forEach(option => {
            const checked = selections[questionData["ID"]] && selections[questionData["ID"]].selectedOption === option ? "checked" : "";
            optionsHtml += `<li><label><input type="radio" name="${questionData["ID"]}" value="${option}" ${checked} onchange="saveSelection('${questionData["ID"]}', '${option}')"> ${option}</label></li>`;
        });
        document.getElementById('options-list').innerHTML = optionsHtml;
        
        // Highlight the selected question in the list
        document.querySelector('.selected-question')?.classList.remove('selected-question');
        document.querySelectorAll('.question-item')[questionNumber - 1].classList.add('selected-question');
        
        currentQuestion = questionNumber;
    }

    function saveSelection(questionID, selectedOption) {
        if (!selections[questionID]) {
            selections[questionID] = {};
        }
        selections[questionID].selectedOption = selectedOption; // Save the selected option
        selections[questionID].timeSpent = selections[questionID].timeSpent || 0; // Ensure timeSpent is initialized
        localStorage.setItem('selections', JSON.stringify(selections));
        console.log("Saved selection for " + questionID + ": " + selectedOption + " (Time spent: " + selections[questionID].timeSpent + " seconds)");
    }
    
    function submitForm() {
        // Check if selections object is populated
        if (Object.keys(selections).length === 0) {
            alert("You haven't selected any answers.");
            return;
        }
        else {
            // Create a hidden form input to store all selections
            let form = document.getElementById('testForm');
            let hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'selections';
            hiddenInput.value = JSON.stringify(selections);
            form.appendChild(hiddenInput);
            
            // Clear localStorage (optional, depending on your needs)
            localStorage.removeItem('selections');

            // Submit the form
            form.submit();
        }
    }

    window.onload = function () {
        selectQuestion(1); // Select the first question by default
        startTimer();  // Start the countdown timer
    };
  </script>
</html>
